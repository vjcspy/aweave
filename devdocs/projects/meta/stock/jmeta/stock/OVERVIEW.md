# JMeta Stock Package Overview

> TL;DR: JMeta stitches together shared Quarkus infrastructure, a stock market ingestion + analytics engine, and a thin HTTP host. The `packages:stock` module is the business core: it syncs Vietstock listings, FireAnt prices, and Simplize ticks into PostgreSQL, exposes APIs, and queues trading-analysis jobs, while shared modules supply reactive event orchestration, Slack telemetry, and cross-cutting filters.

## Table of Contents
- [Inventory & Layout](#inventory--layout)
- [Repo Purpose & Interactions](#repo-purpose--interactions)
- [Domain Data & Flow](#domain-data--flow)
- [Key Logic](#key-logic)
- [External Dependencies & Cross-Service Contracts](#external-dependencies--cross-service-contracts)
- [Operational Notes](#operational-notes)

## Inventory & Layout

```
settings.gradle                          – declares the multi-project build (`shared:*`, `packages:*`, `projects:http`) so Gradle wires module publishing (`settings.gradle:13-21`)
shared/common/                           – framework-agnostic DTOs and error base classes (`shared/common/src/main/java/com/vjcspy/common/api/**`)
shared/quarkus-base/                     – Quarkus filters, exception mappers, reactive-event runtime, logging helpers (`shared/quarkus-base/src/main/java/com/vjcspy/quarkus/base/**`)
packages/base/                           – reusable domain services (currently a Slack client + flood-control effect) (`packages/base/src/main/java/com/vjcspy/base/**`)
packages/stock/                          – stock info ingestion, messaging, schedulers, REST controllers, and trading analytics
projects/http/                           – runnable Quarkus app bundling all modules, Flyway migrations, Dockerfiles, and dev/testing endpoints
devdocs/projects/jmeta/stock/OVERVIEW.md – this onboarding brief
```

## Repo Purpose & Interactions

Gradle includes six modules so we can publish shared libraries and feature packages independently while `projects/http` composes them into a Quarkus service (`settings.gradle:13-21`). The core flows are:

1. **Symbol + market data ingestion:** `packages/stock` fetches Vietstock listings, FireAnt daily prices, and Simplize ticks, persists them via Panache repositories, and exposes REST endpoints for downstream systems.
2. **Reactive job orchestration:** RabbitMQ queues carry “sync prices”, “sync ticks”, and “build trading analysis” commands. Consumers dispatch actions into the shared `ReactiveEventManager`, which fans out to effect classes that own the ingest pipelines.
3. **Analytics + automation:** A trading-analysis service consumes price data, computes metrics, and persists them; Vert.x schedulers trigger bulk syncs; Slack notifications summarize outcomes or anomalies.

| Integration | Interface / Topics | Config Location | Callers | Notes |
| --- | --- | --- | --- | --- |
| PostgreSQL + Flyway | Vert.x reactive datasource + Panache ORM | `projects/http/src/main/resources/application.properties:4-35` plus schema DDL in `projects/http/src/main/resources/db/migration/V1.0.0__http.sql:1-60` | All JPA entities (`packages/stock/src/main/java/com/vjcspy/stock/**/*Entity.java`) | Schema contains `stock_info_*` and `stock_trading_*` tables. Flyway baselines at version 1 and keeps JSON mapping in “ignore” mode so REST object mappers don’t interfere. |
| RabbitMQ – stock info commands | SmallRye Reactive Messaging channels `stock-info-publisher` / `stock-info-consumer` | `packages/stock/src/main/resources/application.properties:4-12` | `StockInfoPublisher`, `StockInfoConsumer`, `StockInfoPriceSyncEffect`, `StockInfoTickSyncEffect`, `StockInfoStockEffect` | Publishes to exchange `jmeta.stock.info`, manual ack with correlation IDs, `max-outstanding-messages=4` and retries/backoff per effect. |
| RabbitMQ – trading analysis | Channels `analysis-publisher` / `analysis-consumer` | `packages/stock/src/main/resources/application.properties:14-24` | `StockTradingAnalysisPublisher`, `StockTradingAnalysisConsumer` | Uses a dedicated exchange `jmeta.stock.trading.analysis` with auto-ack on the consumer side because retries are handled upstream. |
| Slack workspace | MicroProfile REST client `slack-api` | `packages/base/src/main/java/com/vjcspy/base/domain/slack/SlackService.java:22-204` | `SlackService`, `BaseSlackEffect`, `StockInfoEventBus` | Messages are prefixed with `[app|env]` metadata, rely on `slack.url` / `slack.token`, and a `BaseSlackEffect` throttles floods and batches summaries. |
| Vietstock portal (corporate AZ) | Form POST to `/data/corporateaz` with cookies + CSRF | `packages/stock/src/main/resources/application.properties:26-47` and `VietstockRestClient` (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/vietstock/rest/VietstockRestClient.java:11-26`) | `VietstockHttpClient` and `StockInfoStockService` | `VietstockCredentialsService` logs in, extracts `__RequestVerificationToken`, and caches cookies for one hour before calling `VietstockRestClient`. Retries happen up to three times with credential invalidation on parse failures (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/vietstock/VietstockCredentialsService.java:34-157`, `VietstockHttpClient.java:28-84`). |
| Simplize API (ticks) | GET `/api/historical/ticks/{symbol}` | `packages/stock/src/main/resources/application.properties:33-38` and `SimplizeRestClient` (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/tick/rest/SimplizeRestClient.java:12-19`) | `StockInfoTickService` -> `StockInfoTickSyncEffect` | 5s connect/15s read timeouts. `StockInfoTickService.syncSymbol` retries the client up to three times and interprets missing data based on market status (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/tick/StockInfoTickService.java:111-205`). |
| FireAnt REST (historical quotes) | GET `/symbols/{symbol}/historical-quotes` with Bearer auth | `packages/stock/src/main/resources/application.properties:49-55`, `FireAntPriceClient` (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/price/rest/FireAntPriceClient.java:10-20`) | `PriceFetchService` -> `StockInfoPriceSyncEffect` | Uses injected token, retries three times with 5s/15s timeouts, and scales prices to the storage format before persisting (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/price/rest/PriceFetchService.java:21-45`). |
| Vert.x Event Bus | Addresses such as `PUBLISH_SYNC_PRICE_ALL_SYMBOL`, `REPORT_TICK_COUNT_TODAY` | Defined in `StockInfoEventBus` (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/reactive/bus/StockInfoEventBus.java:21-188`) | `StockInfo*Scheduler`, `StockInfoEventBus`, Slack service | Event bus jobs throttle bulk operations, aggregate Slack reports, and dispatch reactive actions such as re-syncing every exchange. |

## Domain Data & Flow

### Stock registry (Vietstock ingestion)
- **Data model:** `StockInfoStockEntity` maps the `stock_info_stocks` table with exchange, industries, and first-trade metadata (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/stock/StockInfoStockEntity.java:7-44`; schema created in `V1.0.0__http.sql:21-40`).
- **Ingestion:** `StockInfoStockService` streams Vietstock pages, truncates the table when page 1 has data, and upserts rows inside transactional `VirtualUni` blocks (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/stock/StockInfoStockService.java:18-102`). It relies on `VietstockHttpClient` to POST to `/data/corporateaz` with retries and credential invalidation, and on `VietstockMapper` to translate `/Date(...)` formats (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/vietstock/VietstockHttpClient.java:28-85`, `VietstockMapper.java:22-111`).
- **Pipelines & APIs:** `StockInfoStockEffect` listens for `STOCK_SYNC_START/LOAD` actions and keeps fetching pages until fewer than 50 records remain (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/reactive/event/stock/StockInfoStockEffect.java:36-109`). Schedulers emit refresh commands nightly (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/scheduler/stock/StockInfoStockScheduler.java:20-32`), and `StockResource` exposes `/stocks` endpoints plus a manual `/stocks/sync` trigger (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/controller/StockResource.java:20-64`).

### Price history (FireAnt pipeline)
- **Data model:** `StockInfoPriceEntity` stores OHLC, volume, and foreign flow metrics per symbol/date (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/price/StockInfoPriceEntity.java:11-69`).
- **Ingestion pipeline:** `PriceFetchService` uses the FireAnt client and scales values to integers before building DTOs (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/price/rest/PriceFetchService.java:21-45`). `StockInfoPriceSyncEffect` orchestrates start → load → save → finish/error actions, feeds the fetcher, upserts via `StockInfoPriceService`, and finally acks/nacks the originating Rabbit message via `CorrelatedMessageStore` (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/reactive/event/price/StockInfoPriceSyncEffect.java:55-244`; `packages/stock/src/main/java/com/vjcspy/stock/stockinfo/messaging/CorrelatedMessageStore.java:10-28`). Successful jobs store their window in `StockInfoSyncStatusService` for resumable runs (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/syncstatus/StockInfoSyncStatusService.java:15-74`).
- **Operations:** `StockInfoEventBus` broadcasts `/sync price all` jobs (with optional truncate) and reports Slack warnings if symbol counts look off (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/reactive/bus/StockInfoEventBus.java:69-93,164-188`). `PriceResource` exposes price lookup APIs and the `/prices/sync` endpoints that enqueue new Rabbit messages or publish a bus broadcast (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/controller/PriceResource.java:24-122`).

### Tick capture (Simplize pipeline)
- **Data model:** `StockInfoTickEntity` keeps JSONB price tick blobs (schema in `V1.0.0__http.sql:49-60`), while `StockInfoTickService` offers read APIs plus history grouping (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/tick/StockInfoTickEntity.java:10-25`, `StockInfoTickService.java:33-259`).
- **Ingestion pipeline:** `StockInfoTickService.syncSymbol` guards against repeated failures, fetches the Simplize array-of-arrays payload, and writes or bypasses data depending on market status cached per day (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/tick/StockInfoTickService.java:111-245`). `StockInfoTickSyncEffect` fans out symbols (optionally limited) and handles success/Slack-error/ack flows (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/reactive/event/tick/StockInfoTickSyncEffect.java:52-223`). Full-market syncs and health reports are driven by `StockInfoEventBus` addresses triggered from `StockInfoTickScheduler` (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/scheduler/tick/StockInfoTickScheduler.java:20-32` and `StockInfoEventBus.java:48-162`).
- **APIs:** `TickResource` presents CRUD-style endpoints (latest tick, per-day, available ranges) and exposes `/ticks/sync` toggles for targeted or all-symbol syncs (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/controller/TickResource.java:25-155`).

### Trading analytics
- **Data model:** `StockTradingAnalysisEntity` and `StockTradingFeatureCandle` capture aggregated metrics (`packages/stock/src/main/java/com/vjcspy/stock/stocktrading/domain/analysis/StockTradingAnalysisEntity.java:13-96`, `packages/stock/src/main/java/com/vjcspy/stock/stocktrading/domain/feature/StockTradingFeatureCandle.java:14-62`).
- **Compute flow:** `StockTradingAnalysisService` pulls recent prices (`StockInfoPriceService`), calculates rolling trade values and foreign buy/sell deltas, and stores/upserts via MapStruct (`packages/stock/src/main/java/com/vjcspy/stock/stocktrading/domain/analysis/StockTradingAnalysisService.java:20-248`). Commands arrive through Rabbit via `StockTradingAnalysisPublisher` and `StockTradingAnalysisConsumer`, which propagate correlation IDs and reuse the shared `MessageErrorHandler` for dead-letter logging (`packages/stock/src/main/java/com/vjcspy/stock/stocktrading/messaging/analysis/StockTradingAnalysisPublisher.java:36-133`, `StockTradingAnalysisConsumer.java:24-95`). External callers hit `StockTradingResource` to view, enqueue, or update analyses (`packages/stock/src/main/java/com/vjcspy/stock/stocktrading/controller/StockTradingResource.java:15-140`).

### Observability & automation
- **Reactive runtime:** `ReactiveEventManager` registers all `@Effect` handlers at startup and forwards `ReactiveEventAction`s over a dedicated Vert.x event bus channel with bounded concurrency and correlation propagation (`shared/quarkus-base/src/main/java/com/vjcspy/quarkus/base/reactive/event/ReactiveEventInitializer.java:18-203`, `ReactiveEventManager.java:18-116`).
- **Slack & throttling:** `SlackService` wraps the webhook endpoint, while `BaseSlackEffect` buffers high-volume flows (`packages/base/src/main/java/com/vjcspy/base/domain/slack/SlackService.java:22-204`, `packages/base/src/main/java/com/vjcspy/base/reactive/event/slack/BaseSlackEffect.java:30-196`). Stock ingest effects emit `SlackActions.message(...)` when errors occur, so the operations channel sees batched alerts.
- **Dev/test harness:** `TedbedResource` and `ContextTestResource` demonstrate correlation-ID propagation through Uni chains and downstream services, making it easy to diagnose MDC leaks while iterating locally (`packages/stock/src/main/java/com/vjcspy/stock/tedbed/controller/TedbedResource.java:20-84`, `ContextTestResource.java:20-103`).

## Key Logic

- **Reactive event mesh:** Every `@Effect` method registers with the shared `ReactiveEventManager`, which emits derived actions on a Vert.x bus and keeps correlation IDs in the `RequestContext` MDC (`shared/quarkus-base/src/main/java/com/vjcspy/quarkus/base/reactive/event/ReactiveEventManager.java:18-116`). This allows the stock pipelines (`StockInfoPriceSyncEffect`, `StockInfoTickSyncEffect`, `StockInfoStockEffect`) to be entirely declarative yet still sequenced.
- **Rabbit command lifecycle:** `StockInfoPublisher` enforces at-most-three tries with 50 ms backoff before giving up (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/messaging/StockInfoPublisher.java:16-27`). Messages include `X-Message-Correlation-ID`, are stored in `CorrelatedMessageStore`, and later acked/nacked inside effects, ensuring no ghost messages after failures (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/messaging/StockInfoConsumer.java:34-90`, `CorrelatedMessageStore.java:10-28`).
- **Price pipeline sequencing:** `StockInfoPriceSyncEffect` reprises the Node.js batch semantics—load paginated FireAnt slices, upsert them with `StockInfoPriceService`, and either dispatch another LOAD or FINISH. Completed runs update `StockInfoSyncStatusService` and ack the Rabbit message; failures create Slack messages and nacks (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/reactive/event/price/StockInfoPriceSyncEffect.java:55-244`).
- **Tick pipeline safeguards:** `StockInfoTickSyncEffect` distributes symbol lists sequentially, pauses between messages, and escalates Slack alerts or nacks when Simplize errors exceed retries (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/reactive/event/tick/StockInfoTickSyncEffect.java:52-207`). `StockInfoTickService` determines whether to treat missing data as “market closed” by checking the price table for a configurable symbol each day (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/tick/StockInfoTickService.java:222-245`).
- **Slack flood control:** When high-volume errors appear, `BaseSlackEffect` batches them per process flow, schedules a flush via Vert.x timers, and emits a one-off notice so operators are not spammed (`packages/base/src/main/java/com/vjcspy/base/reactive/event/slack/BaseSlackEffect.java:31-196`).
- **HTTP surface:** `StockResource`, `PriceResource`, `TickResource`, and `StockTradingResource` expose read APIs and control-plane actions, all returning the shared `ApiResponse` wrapper to keep clients consistent (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/controller/*.java`, `packages/stock/src/main/java/com/vjcspy/stock/stocktrading/controller/StockTradingResource.java:33-138`, `shared/common/src/main/java/com/vjcspy/common/api/response/ApiResponse.java:8-36`).
- **Schedulers & telemetry:** Cron-style schedulers publish Vert.x bus commands for nightly syncs and audit Slack reports (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/scheduler/**`). `StockInfoEventBus` handles those commands, throttles outbound Rabbit publishing (150 ms delay), and pushes aggregated stats (per-exchange tick coverage) to Slack (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/reactive/bus/StockInfoEventBus.java:48-162`).
- **Analytics messaging:** `StockTradingAnalysisPublisher` decouples HTTP requests from heavy computations by pushing symbols to Rabbit with correlation metadata, while `StockTradingAnalysisConsumer` runs `StockTradingAnalysisService.buildAndSaveAnalysisData`, logs via `MessageErrorHandler`, and clears MDC context at the end (`packages/stock/src/main/java/com/vjcspy/stock/stocktrading/messaging/analysis/*.java`, `shared/quarkus-base/src/main/java/com/vjcspy/quarkus/base/exception/MessageErrorHandler.java:19-132`).

## External Dependencies & Cross-Service Contracts

- **PostgreSQL (Quarkus datasource):** Configured via `projects/http/src/main/resources/application.properties:4-35`, with Flyway baseline `V1.0.0__http.sql`. Expect credentials (`postgres.k8s/admin123`) to be overridden in deployment. JSON columns rely on `quarkus.hibernate-orm.mapping.format.global=ignore`, so custom serializers must respect that. Flyway runs at startup, so schema drift will fail boot.
- **RabbitMQ:** Both command buses use the `smallrye-rabbitmq` connector (`packages/stock/src/main/resources/application.properties:4-24`). `stock-info-consumer` disables auto-ack so effects can nack on error; `analysis-consumer` auto-acks because downstream uses `MessageErrorHandler` to log. Credentials come from `projects/http` config (`rabbitmq-username`/`password`), so align them with the broker you deploy.
- **Slack webhook:** `SlackService` expects `slack.url` + `slack.token` MicroProfile config values; it decorates text with app/profile tags and logs all failures (`packages/base/src/main/java/com/vjcspy/base/domain/slack/SlackService.java:22-166`). `BaseSlackEffect` is wired into the same reactive event manager, so you can emit `SlackActions.message(processFlow, text)` from any module.
- **Vietstock corporate AZ endpoint:** Authentication is cookie-based with CSRF. `VietstockCredentialsService` logs in, merges cookies, and refreshes hourly, while `VietstockHttpClient.fetchPage` retries three times before invalidating the cache (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/vietstock/VietstockCredentialsService.java:34-157`, `VietstockHttpClient.java:28-84`). Environment variables `STOCK_VIETSTOCK_EMAIL` / `STOCK_VIETSTOCK_PASSWORD` should override the hard-coded defaults.
- **FireAnt REST:** Authorization uses a long-lived Bearer token (`packages/stock/src/main/resources/application.properties:49-55`). `PriceFetchService` automatically retries with backoff and converts decimals to scaled ints to match the DB schema (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/price/rest/PriceFetchService.java:21-45`). Rotate tokens regularly to avoid expiry-induced gaps.
- **Simplize ticks:** GET requests are simple, but payload validation is strict: the service expects `[epochSeconds, price, volume, ...]` arrays and will fail fast otherwise (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/domain/tick/StockInfoTickService.java:151-187`). If Simplize returns no data while the market is closed, `StockInfoTickService` still records an empty array and marks the sync successful.
- **Vert.x Event Bus + schedules:** Cron definitions in `packages/stock/src/main/java/com/vjcspy/stock/stockinfo/scheduler/*.java` publish plain objects to addresses. `StockInfoEventBus` listens using `@ConsumeEvent`, throttles message emission with `onItem().call(...delay...)`, and pushes aggregated Slack summaries (per-exchange counts) (`packages/stock/src/main/java/com/vjcspy/stock/stockinfo/reactive/bus/StockInfoEventBus.java:48-162`).
- **HTTP surface:** Controllers under `/stocks`, `/prices`, `/ticks`, and `/stock-trading` all return the shared `ApiResponse` envelope. `projects/http/src/main/java/com/vjcspy/http/PrivateResource.java:10-31` also exposes `/private/info` for build metadata, and `/hello/slack` exercises the Slack client (`projects/http/src/main/java/com/vjcspy/http/GreetingResource.java:11-35`).
