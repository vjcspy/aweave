---
name: Demo Workflow Plugin
description: oclif plugin running demo workflow showcase as reference implementation for the workflow engine
tags: []
---

# Demo Workflow Plugin (`@hod/aweave-plugin-demo-workflow`)

> **Source:** `workspaces/devtools/common/cli-plugin-demo-workflow/`
> **Last Updated:** 2026-02-09

oclif plugin chạy demo workflow showcase tất cả features của workflow engine. Đây là **reference implementation** — khi tạo workflow mới, copy pattern từ package này.

Command: `aw demo [--format interactive|json]`

## Purpose

- **Case study** — Demonstrate tất cả engine features trong 1 workflow hoàn chỉnh
- **Reference implementation** — Template cho mọi workflow plugin mới
- **Integration test** — Verify engine + dashboard + xstate hoạt động end-to-end
- **Non-interactive mode** — JSON output với auto-resolve human input

## Demo Workflow: 7 Stages

```
Stage 1: Validate Environment      [parallel ∥]
  ├── Check Node.js                  → simulated, 400ms
  ├── Check Git                      → simulated, 600ms
  └── Check Disk                     → simulated, 350ms

Stage 2: Run Tests (Race)           [race ⚡]
  ├── Unit Tests (fastest)           → wins (~1s), others cancelled
  ├── Integration Tests              → cancelled
  └── E2E Tests                      → cancelled

Stage 3: Code Analysis              [parallel ∥, dynamic, reducer]
  ├── Lint core     ┐
  ├── Lint api      │ generated by prepareTasks()
  ├── Lint auth     │ from hardcoded module list
  ├── Lint database │ reducer aggregates total issues
  └── Lint utils    ┘

Stage 4: Review & Approve           [sequential →, human-in-the-loop]
  └── Approval Gate                  → waitForInput() with 4 options

Stage 5: Deploy                     [sequential →, conditional, retry]
  ├── Build                          → streaming output
  └── Deploy Staging                 → fails attempt 1 (ECONNRESET),
                                       succeeds attempt 2 (exponential backoff)

Stage 6: Generate Report            [sequential →, conditional]
  └── Generate Report                → streaming output, 4 sections

Stage 7: Notify                     [sequential →, timeout, onFailed: skip]
  └── Send Notifications             → 3 channels, timeout: 10s
                                       onFailed returns { action: 'skip' }
```

### Feature Coverage Matrix

| Feature | Stage | How |
|---------|-------|-----|
| Parallel execution | 1, 3 | `execution: 'parallel'` |
| Race + cancellation | 2 | `execution: 'race'`, handlers check `ctx.signal.aborted` |
| Dynamic tasks | 3 | `prepareTasks()` generates 5 tasks from module list |
| Stage reducer | 3 | `reducer()` aggregates `totalIssues`, `totalWarnings`, `totalFiles` |
| Human-in-the-loop | 4 | `ctx.waitForInput()` with 4 options (deploy/report/skip/abort) |
| Conditional stage | 5, 6 | `condition()` checks user decision from stage 4 |
| Retry + backoff | 5 | `retry: { maxAttempts: 3, delayMs: 1000, backoff: 'exponential' }` |
| Streaming output | 5, 6 | `ctx.stream()` for build/deploy/report progress |
| Timeout | 7 | `timeout: 10_000` on notification task |
| onFailed: skip | 7 | `onFailed: () => ({ action: 'skip' })` |
| Logging | All | `ctx.log()` at info/warn/error levels |
| Idempotency | 5 | `ctx.execution.attempt` used in deploy handler |

## Non-Interactive Mode (JSON)

Khi stdin không có raw mode (IDE terminals, CI) hoặc `--format json`:

1. Logs stream to stderr: `[HH:MM:SS] [LEVEL] message`
2. Human input auto-resolved: `defaultValue ?? options[0]?.value ?? ''`
3. Final JSON output to stdout: stages, tasks, status, duration

**Auto-resolve gotcha:** Must use `setTimeout` to defer `HUMAN_INPUT` event, avoiding re-entrant xstate updates within `subscribe` callback.

## Dependencies

| Package | Role |
|---------|------|
| `@hod/aweave-workflow-engine` (workspace:*) | `workflowMachine`, types |
| `@hod/aweave-workflow-dashboard` (workspace:*) | `WorkflowDashboard` component |
| `@oclif/core` | Command class, Flags |
| `ink` (^6.6.0) | `render()` |
| `react` (^19.0.0) | `React.createElement()` |
| `xstate` (^5) | `createActor()` |

## Project Structure

```
devtools/common/cli-plugin-demo-workflow/
├── package.json                    # "type": "module", ESM
├── tsconfig.json                   # module: Node16, jsx: react-jsx
├── eslint.config.mjs
└── src/
    ├── index.ts                    # Empty (oclif auto-discovers)
    ├── commands/
    │   └── demo.ts                 # aw demo [--format interactive|json]
    └── workflow.ts                 # WorkflowDefinition (7 stages, all handlers inline)
```

### Key files

- **`workflow.ts`** — Complete `WorkflowDefinition` with all 7 stages and inline handlers. ~300 lines. Good starting point when copying for a new workflow.
- **`commands/demo.ts`** — Command with TTY detection, interactive/JSON dual mode, auto-resolve human input pattern.

## Development

```bash
cd workspaces/devtools/common/cli-plugin-demo-workflow

# Build (requires engine + dashboard built first)
pnpm build

# Test interactive (requires real terminal — iTerm, Terminal.app)
aw demo

# Test JSON mode (works anywhere)
aw demo --format json

# Force JSON fallback (IDE terminal without raw mode)
aw demo    # auto-detects and falls back to JSON
```

## Creating a New Workflow Plugin

Copy this package as template:

1. Copy `cli-plugin-demo-workflow/` → `cli-plugin-<name>/`
2. Update `package.json` name
3. Replace `workflow.ts` with your `WorkflowDefinition`
4. Replace `commands/demo.ts` → `commands/<name>.ts`
5. Register in `pnpm-workspace.yaml` + `cli/package.json`

Detailed guide: `agent/skills/common/workflow-builder/SKILL.md`

## Related

- **Engine:** `workspaces/devtools/common/workflow-engine/` — `resources/workspaces/devtools/common/workflow-engine/OVERVIEW.md`
- **Dashboard:** `workspaces/devtools/common/workflow-dashboard/` — `resources/workspaces/devtools/common/workflow-dashboard/OVERVIEW.md`
- **Design Plan:** `resources/workspaces/devtools/common/_plans/260208-workflow-engine.md`
- **Builder Skill:** `agent/skills/common/workflow-builder/SKILL.md`
- **CLI Builder Skill:** `agent/skills/common/devtools-cli-builder/SKILL.md`
- **Global Overview:** `resources/workspaces/devtools/OVERVIEW.md`
